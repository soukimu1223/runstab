# 要件定義書

## 概要

**RunStab**（仮称）は、フォーム分析を誰もが手軽に行えることを目指すiOSアプリです。

これまで走フォームの客観的な分析には、専門のラボへ行き高額な費用と特殊な装置が必要でした。一般のランナーやアスリートがそこにアクセスするのは現実的ではありません。RunStabは「定点カメラで撮った動画」と「スマートフォン」だけで、選手を中心に固定したトレッドミル風の縦動画を生成します。

日常的に同じ条件で撮影・変換した動画を蓄積していくことで、フォームの変化を自分自身で観察・比較できるきっかけを提供します。

**MVPのスコープ:**
定点カメラで撮影した動画を読み込み、始点・終点を指定するだけで、ランナーを中心に追跡した動画を書き出す。それだけ。

---

## 用語集

- **RunStab_App**: 本iOSアプリケーション全体
- **Source_Video**: カメラロールから読み込む処理対象の元動画
- **Tracking_Point**: ユーザーが画面タップで指定する、特定フレームにおける選手の中心座標（フレーム番号 + x, y）
- **Start_Point**: 選手が最初に画面に映るフレームでのTracking_Point
- **End_Point**: 選手が最後に画面に映るフレームでのTracking_Point
- **Trajectory**: Start_PointとEnd_Pointを線形補間した、全フレームの追跡座標列
- **Crop_Region**: 各フレームから切り出す矩形領域。Trajectoryの座標を中心に、選手サイズに合わせた幅・高さ
- **Output_Video**: Crop_Regionを9:16にリサイズして書き出した縦動画
- **Frame_Scrubber**: 動画を1フレーム単位でスクラブするUIコンポーネント
- **Runner_Box**: 選手の身体範囲を示すバウンディングボックス。Crop_Region計算に使用

---

## 要件

### 要件 1

**ユーザーストーリー:** コーチとして、撮影した動画をすぐに選手分析に使いたいので、カメラロールから動画を素早く読み込みたい

#### 受入基準

1. ユーザーがRunStab_Appを起動したとき、RunStab_AppはカメラロールへのアクセスをiOS標準のphotosピッカーで要求する
2. ユーザーがSource_Videoを選択したとき、RunStab_Appは3秒以内にFrame_Scrubberを表示する
3. RunStab_Appは縦動画（9:16）・横動画（16:9）どちらも読み込める
4. RunStab_Appは動画のフレーム数・再生時間・解像度をUI上に表示する
5. ユーザーが別の動画を選び直せるよう、RunStab_Appは動画選択画面への戻るボタンを提供する

---

### 要件 2

**ユーザーストーリー:** コーチとして、複数の選手が映っていても特定の選手だけを追跡したいので、開始・終了位置を自分でタップして指定したい

#### 受入基準

1. RunStab_Appはユーザーが1フレーム単位でスクラブできるFrame_Scrubberを提供する
2. ユーザーがFrame_Scrubberで選手が最初に映るフレームを表示したとき、RunStab_Appは画面タップでStart_Pointを記録する
3. ユーザーがFrame_Scrubberで選手が最後に映るフレームを表示したとき、RunStab_Appは画面タップでEnd_Pointを記録する
4. ユーザーが選手の頭部と足部をそれぞれタップしたとき、RunStab_AppはRunner_Box（選手の高さ・幅）を計算し、Crop_Regionサイズに反映する
5. RunStab_AppはStart_PointとEnd_Pointを視覚的なマーカー（ピン）で表示し、ユーザーが設定済みであることを確認できる
6. ユーザーがマーカーをタップしたとき、RunStab_Appはそのポイントを再設定できる
7. Start_PointまたはEnd_Pointが未設定の場合、RunStab_Appは処理開始ボタンを無効化し理由をメッセージで表示する

---

### 要件 3

**ユーザーストーリー:** コーチとして、処理中に他の操作ができるよう、動画変換がバックグラウンドで動いてほしい

#### 受入基準

1. ユーザーが処理を開始したとき、RunStab_AppはTrajectoryをStart_PointとEnd_Pointの線形補間で計算する
2. RunStab_AppはStart_Point以前のフレームではStart_Pointの座標でCrop_Regionを固定し、End_Point以降ではEnd_Pointの座標で固定する
3. RunStab_Appは各フレームをCrop_Regionで切り出し、1080×1920px（9:16）にリサイズしてOutput_Videoに書き出す
4. RunStab_Appはフレーム処理の進捗をプログレスバーとパーセンテージで表示する
5. RunStab_Appは処理中にアプリがバックグラウンドに移行した場合も処理を継続する
6. 処理が完了したとき、RunStab_Appは完了通知をプッシュ通知で表示する
7. ユーザーが処理をキャンセルしたとき、RunStab_AppはOutput_Videoの中間ファイルを削除する

---

### 要件 4

**ユーザーストーリー:** コーチとして、変換結果がすぐに共有できるよう、Output_Videoをカメラロールに保存したい

#### 受入基準

1. 処理完了後、RunStab_AppはOutput_Videoをカメラロールの「RunStab」アルバムに自動保存する
2. RunStab_Appはカメラロールへの書き込みにiOS標準のPhotoKit APIを使用し、権限がない場合は設定画面へ誘導する
3. RunStab_Appは保存完了後にOutput_Videoのインラインプレビューを表示する
4. ユーザーがプレビューを確認後、RunStab_AppはiOS標準の共有シートを起動してAirDrop・LINE・SNS等への共有を可能にする
5. RunStab_AppはOutput_Videoのファイルサイズと保存先パスをUI上に表示する

---

### 要件 5

**ユーザーストーリー:** ランナーとして、アプリを迷わず使いたいので、動画選択から保存まで最短ステップで完結してほしい

#### 受入基準

1. RunStab_AppはiOS 16.0以降をサポートし、SwiftUIで実装する
2. RunStab_Appは動画選択 → 始点指定 → 終点指定 → 処理 → 保存の5ステップ以内でOutput_Videoを生成できる
3. RunStab_Appはダークモード・ライトモードの両方に対応する

---

## 将来的な拡張（MVP対象外）

以下はMVP完成後に検討する機能。要件定義には含めない。

- 自動人物追跡（Vision frameworkによるAI検出）
- 過去動画の一覧・比較表示（フォーム変化の蓄積閲覧）
- フォーム分析・数値化機能
- 複数動画のバッチ処理
- 再処理・設定保存機能
